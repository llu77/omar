'use server';

/**
 * @fileOverview Generates a personalized 12-week rehabilitation plan for a patient based on their assessment data.
 */

import { ai, DEFAULT_MODEL } from '@/ai/genkit';
import { z } from 'zod';

const GenerateRehabPlanInputSchema = z.object({
  job: z.string().describe("The patient's job."),
  symptoms: z.string().describe("The patient's symptoms."),
  age: z.number().describe('The age of the patient.'),
  gender: z.string().describe('The gender of the patient.'),
  neck: z.string().describe('Neck control (yes/partially/no).'),
  trunk: z.string().describe('Trunk control (yes/partially/no).'),
  standing: z.string().describe('Standing ability (yes/assisted/no).'),
  walking: z.string().describe('Walking ability (yes/assisted/no).'),
  medications: z.string().describe('Medications (yes/no + details).'),
  fractures: z.string().describe('Fractures (yes/no + location).'),
});
export type GenerateRehabPlanInput = z.infer<typeof GenerateRehabPlanInputSchema>;

const GenerateRehabPlanOutputSchema = z.object({
  rehabPlan: z.string().describe('A detailed 12-week rehabilitation plan.'),
  initialDiagnosis: z.string().describe('The initial diagnosis.'),
  prognosis: z.string().describe('The scientific prognosis for the case.'),
  precautions: z.string().describe('Any precautions to take.'),
  reviewAppointments: z.string().describe('Recommended review appointments.'),
});
export type GenerateRehabPlanOutput = z.infer<typeof GenerateRehabPlanOutputSchema>;

export async function generateRehabPlan(input: GenerateRehabPlanInput): Promise<GenerateRehabPlanOutput> {
  return generateRehabPlanFlow(input);
}

const prompt = ai.definePrompt({
  name: 'generateRehabPlanPrompt',
  input: {
    schema: GenerateRehabPlanInputSchema,
  },
  output: {
    schema: GenerateRehabPlanOutputSchema,
  },
  model: DEFAULT_MODEL,
  config: {
    temperature: 0.7,
    maxOutputTokens: 4000,
  },
  prompt: `ุฃูุช ุงุณุชุดุงุฑู ุชุฃููู ุทุจู ุฐู ุฎุจุฑุฉ ุนุงููุฉ. ูุทููุจ ููู ุฅุนุฏุงุฏ ุฎุทุฉ ุชุฃููู ุดุงููุฉ ููุจููุฉ ุนูู ุฃุณุณ ุนูููุฉ ููุฑูุถ ูุญุชุงุฌ ุจุฑูุงูุฌ ุชุฃูููู ูุชุฎุตุต.

**ุจูุงูุงุช ุงููุฑูุถ:**
- ุงููุธููุฉ: {{{job}}}
- ุงูุฃุนุฑุงุถ: {{{symptoms}}}
- ุงูุนูุฑ: {{{age}}} ุณูุฉ
- ุงูุฌูุณ: {{{gender}}}
- ุงูุชุญูู ุจุงูุฑูุจุฉ: {{{neck}}}
- ุงูุชุญูู ุจุงูุฌุฐุน: {{{trunk}}}
- ุงููุฏุฑุฉ ุนูู ุงููููู: {{{standing}}}
- ุงููุฏุฑุฉ ุนูู ุงููุดู: {{{walking}}}
- ุงูุฃุฏููุฉ: {{{medications}}}
- ุงููุณูุฑ: {{{fractures}}}

**ุชุนูููุงุช ูููุฉ ุฌุฏุงู:**
- ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุฅุฌุงุจุงุช ูุตูุต ูุงููุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูููุณุช JSON objects
- ุงูุชุจ ูู ูุณู ููุต ูุชุตู ูููุณ ูู JSON
- ุงุณุชุฎุฏู ุงูููุฑุงุช ูุงูุชูุณูู ุงููุตู ุงูุนุงุฏู

**ุงููุทููุจ ููู ุชูุฏูู ุงูุฃูุณุงู ุงูุชุงููุฉ:**

1. **ุงูุชุดุฎูุต ุงูุฃููู (initialDiagnosis):**
ุงูุชุจ ููุฑุฉ ูุงุญุฏุฉ ูุชุตูุฉ ุชุญุชูู ุนูู ุงูุชุดุฎูุต ุงูุทุจู ุงูุฃููู ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูููุฏูุฉ.

2. **ุงูุชููุนุงุช ุงูุนูููุฉ (prognosis):**
ุงูุชุจ ููุฑุฉ ูุงุญุฏุฉ ูุชุตูุฉ ุชุญุชูู ุนูู ูุณุจุฉ ุงูุชุญุณู ุงููุชููุนุฉ ูุงูุฌุฏูู ุงูุฒููู ููุชุนุงูู.

3. **ุฎุทุฉ ุงูุชุฃููู ูู 12 ุฃุณุจูุน (rehabPlan):**
ุงูุชุจ ุฎุทุฉ ุชุฃููููุฉ ููุตูุฉ ููุต ูุชุตู ูุญุชูู ุนูู:

ุงูุฃุณุงุจูุน 1-4 (ุงููุฑุญูุฉ ุงูุฃูููุฉ):
- ุงูุชูุงุฑูู ุงูุนูุงุฌูุฉ ูุน ุนุฏุฏ ุงููุฌููุนุงุช ูุงูุชูุฑุงุฑุงุช
- ูุฏุฉ ูู ุฌูุณุฉ ููุชุฑุงุช ุงูุฑุงุญุฉ
- ุงูุฃูุฏุงู ุงููุฑุญููุฉ

ุงูุฃุณุงุจูุน 5-8 (ุงููุฑุญูุฉ ุงููุชูุณุทุฉ):
- ุงูุชูุงุฑูู ุงููุชูุฏูุฉ ูุน ุงูุชูุงุตูู
- ุงูุชุฏุฑุฌ ูู ุงูุดุฏุฉ
- ุงูุชูุงุฑูู ุงููุธูููุฉ

ุงูุฃุณุงุจูุน 9-12 (ุงููุฑุญูุฉ ุงููุชูุฏูุฉ):
- ุงูุชูุงุฑูู ุงููุชุฎุตุตุฉ
- ุงูุชุญุถูุฑ ููุนูุฏุฉ ููุนูู
- ุจุฑูุงูุฌ ุงููุญุงูุธุฉ

4. **ุงูุงุญุชูุงุทุงุช ุงูุทุจูุฉ (precautions):**
ุงูุชุจ ููุฑุฉ ูุงุญุฏุฉ ูุชุตูุฉ ุชุญุชูู ุนูู ุฌููุน ุงูุงุญุชูุงุทุงุช ูุงูููุงูุน.

5. **ุฌุฏูู ุงููุชุงุจุนุฉ (reviewAppointments):**
ุงูุชุจ ููุฑุฉ ูุงุญุฏุฉ ูุชุตูุฉ ุชุญุชูู ุนูู ููุงุนูุฏ ุงููุฑุงุฌุนุฉ ุงูููุตู ุจูุง.

**ุชุฐููุฑ ููู:** ุงูุชุจ ูู ูุณู ูููุฑุฉ ูุตูุฉ ูุชุตูุฉ ูููุณ ูู JSON ุฃู ูุงุฆูุฉ ูููุทุฉ.`,
});

const generateRehabPlanFlow = ai.defineFlow(
  {
    name: 'generateRehabPlanFlow',
    inputSchema: GenerateRehabPlanInputSchema,
    outputSchema: GenerateRehabPlanOutputSchema,
  },
  async (input) => {
    try {
      // ุชุญูู ูู ุตุญุฉ ุงููุฏุฎูุงุช
      const validatedInput = GenerateRehabPlanInputSchema.parse(input);
      
      console.log('Calling AI model with input:', validatedInput);
      
      // ุงุณุชุฏุนุงุก ุงููููุฐุฌ
      const result = await prompt(validatedInput);
      
      console.log('AI model result:', result);
      
      // ุงูุชุญูู ูู ูุฌูุฏ ูุฎุฑุฌุงุช
      if (!result) {
        throw new Error('No result received from AI model');
      }
      
      // ุงูุชุญูู ูู ูุฌูุฏ output
      if (!result.output) {
        console.error('No output in result:', result);
        throw new Error('No output field in AI model result');
      }
      
      // ูุนุงูุฌุฉ ุฎุงุตุฉ ุฅุฐุง ูุงู rehabPlan ูุงุฆู ุจุฏูุงู ูู ูุต
      let processedOutput = result.output;
      
      // ุงูุชุฃูุฏ ูู ุฃู processedOutput ููุณ null
      if (!processedOutput) {
        throw new Error('Output is null or undefined');
      }
      
      // ูุนุงูุฌุฉ rehabPlan ุฅุฐุง ูุงู object
      if (processedOutput.rehabPlan && typeof processedOutput.rehabPlan === 'object') {
        // ุชุญููู ุงููุงุฆู ุฅูู ูุต ููุณู
        const plan = processedOutput.rehabPlan as any;
        let rehabPlanText = 'ุฎุทุฉ ุงูุชุฃููู ุงูุดุงููุฉ ููุฏุฉ 12 ุฃุณุจูุน:\n\n';
        
        if (plan['weeks1-4']) {
          rehabPlanText += `ุงูุฃุณุงุจูุน 1-4 (ุงููุฑุญูุฉ ุงูุฃูููุฉ):\n`;
          rehabPlanText += `ุงูุชูุงุฑูู ุงูุนูุงุฌูุฉ: ${plan['weeks1-4'].therapeuticExercises || 'ุชูุงุฑูู ุฃุณุงุณูุฉ ููุญุฑูุฉ ูุงููุฑููุฉ'}\n`;
          rehabPlanText += `ุนุฏุฏ ุงููุฌููุนุงุช ูุงูุชูุฑุงุฑุงุช: ${plan['weeks1-4'].setsAndReps || '3 ูุฌููุนุงุช ร 10 ุชูุฑุงุฑุงุช'}\n`;
          rehabPlanText += `ูุฏุฉ ุงูุฌูุณุฉ: ${plan['weeks1-4'].sessionDuration || '30 ุฏูููุฉ'}\n`;
          rehabPlanText += `ูุชุฑุงุช ุงูุฑุงุญุฉ: ${plan['weeks1-4'].restPeriods || 'ุฏูููุฉ ูุงุญุฏุฉ ุจูู ุงููุฌููุนุงุช'}\n`;
          rehabPlanText += `ุงูุฃูุฏุงู: ${plan['weeks1-4'].goals || 'ุชุญุณูู ูุทุงู ุงูุญุฑูุฉ ูุชูููู ุงูุฃูู'}\n\n`;
        }
        
        if (plan['weeks5-8']) {
          rehabPlanText += `ุงูุฃุณุงุจูุน 5-8 (ุงููุฑุญูุฉ ุงููุชูุณุทุฉ):\n`;
          rehabPlanText += `ุงูุชูุงุฑูู ุงููุชูุฏูุฉ: ${plan['weeks5-8'].advancedExercises || 'ุชูุงุฑูู ุชูููุฉ ูุชุฏุฑุฌุฉ'}\n`;
          rehabPlanText += `ุงูุชุฏุฑุฌ ูู ุงูุดุฏุฉ: ${plan['weeks5-8'].gradualIntensityIncrease ? 'ูุนูุ ูุน ุฒูุงุฏุฉ ุชุฏุฑูุฌูุฉ' : 'ุงูุชุฏุฑุฌ ุญุณุจ ุงููุฏุฑุฉ'}\n`;
          rehabPlanText += `ุงูุชูุงุฑูู ุงููุธูููุฉ: ${plan['weeks5-8'].functionalExercises || 'ุชูุงุฑูู ูุฑุชุจุทุฉ ุจุงูุฃูุดุทุฉ ุงูููููุฉ'}\n`;
          rehabPlanText += `ููุงุณ ุงูุชูุฏู: ${plan['weeks5-8'].progressMeasurement || 'ุชูููู ุฃุณุจูุนู ููุชุญุณู'}\n\n`;
        }
        
        if (plan['weeks9-12']) {
          rehabPlanText += `ุงูุฃุณุงุจูุน 9-12 (ุงููุฑุญูุฉ ุงููุชูุฏูุฉ):\n`;
          rehabPlanText += `ุงูุชูุงุฑูู ุงููุธูููุฉ ุงููุชุฎุตุตุฉ: ${plan['weeks9-12'].specializedFunctionalExercises || 'ุชูุงุฑูู ูุชุฎุตุตุฉ ุญุณุจ ุทุจูุนุฉ ุงูุนูู'}\n`;
          rehabPlanText += `ุงูุชุญุถูุฑ ููุนูุฏุฉ ููุนูู: ${plan['weeks9-12'].preparationForReturnToWork || 'ุจุฑูุงูุฌ ุชุฏุฑูุฌู ููุนูุฏุฉ ููุฃูุดุทุฉ ุงูููููุฉ'}\n`;
          rehabPlanText += `ุจุฑูุงูุฌ ุงููุญุงูุธุฉ: ${plan['weeks9-12'].maintenanceProgram || 'ุชูุงุฑูู ููุฒููุฉ ูููุญุงูุธุฉ ุนูู ุงูููุชุณุจุงุช'}\n`;
          rehabPlanText += `ุงูุชูููู ุงูููุงุฆู: ${plan['weeks9-12'].finalEvaluation || 'ุชูููู ุดุงูู ูููุชุงุฆุฌ ุงููุญููุฉ'}`;
        }
        
        // ุฅุฐุง ูู ููู ููุงู ุฃู ูุญุชูู ูู ุงูุฃุณุงุจูุนุ ุงุณุชุฎุฏู ูุต ุงูุชุฑุงุถู
        if (!plan['weeks1-4'] && !plan['weeks5-8'] && !plan['weeks9-12']) {
          rehabPlanText = JSON.stringify(plan, null, 2);
        }
        
        processedOutput = {
          ...processedOutput,
          rehabPlan: rehabPlanText
        };
      }
      
      // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุฌููุน ุงูุญููู ุงููุทููุจุฉ
      const outputWithDefaults = {
        rehabPlan: processedOutput.rehabPlan || 'ุฎุทุฉ ุชุฃููููุฉ ุดุงููุฉ ุณูุชู ุชุฎุตูุตูุง ุจูุงุกู ุนูู ุงูุชูููู ุงูุฃููู',
        initialDiagnosis: processedOutput.initialDiagnosis || 'ูุชุทูุจ ุชููููุงู ุดุงููุงู ูุชุญุฏูุฏ ุงูุชุดุฎูุต ุงูุฏููู',
        prognosis: processedOutput.prognosis || 'ุงูุชููุนุงุช ุฅูุฌุงุจูุฉ ูุน ุงูุงูุชุฒุงู ุจุงูุจุฑูุงูุฌ ุงูุชุฃูููู',
        precautions: processedOutput.precautions || 'ูุฌุจ ูุฑุงุนุงุฉ ุงูุญุงูุฉ ุงูุตุญูุฉ ุงูุนุงูุฉ ูุชุฌูุจ ุงูุฅุฌูุงุฏ ุงูููุฑุท',
        reviewAppointments: processedOutput.reviewAppointments || 'ูุฑุงุฌุนุฉ ูู ุฃุณุจูุนูู ูุชูููู ุงูุชูุฏู'
      };
      
      // ุงูุชุญูู ูู ุตุญุฉ ุงููุฎุฑุฌุงุช
      const validatedOutput = GenerateRehabPlanOutputSchema.parse(outputWithDefaults);
      
      return validatedOutput;
      
    } catch (error: any) {
      console.error('Error in generateRehabPlanFlow:', error);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack,
        name: error.name
      });
      
      // ูู ุญุงูุฉ ุงููุดูุ ูุฑุฌุน ุฎุทุฉ ุชุฃููููุฉ ุฃุณุงุณูุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ
      const fallbackResponse: GenerateRehabPlanOutput = {
        initialDiagnosis: `ุงูุชุดุฎูุต ุงูุฃููู:
        
ุจูุงุกู ุนูู ุงูุชูููู ุงูุดุงูู ูููุฑูุถ:
โข ุงูุนูุฑ: ${input.age} ุณูุฉ - ${input.gender}
โข ุงููุธููุฉ: ${input.job}
โข ุงูุฃุนุฑุงุถ ุงูุฑุฆูุณูุฉ: ${input.symptoms}
โข ุงููุฏุฑุงุช ุงูุญุฑููุฉ: ุชุญูู ุจุงูุฑูุจุฉ (${input.neck})ุ ุชุญูู ุจุงูุฌุฐุน (${input.trunk})
โข ุงููุฏุฑุงุช ุงููุธูููุฉ: ุงููููู (${input.standing})ุ ุงููุดู (${input.walking})

ุงูุชุดุฎูุต: ุถุนู ูู ุงููุฏุฑุงุช ุงูุญุฑููุฉ ูุงููุธูููุฉ ูุชุทูุจ ุจุฑูุงูุฌ ุชุฃููู ูุชูุงูู ูุน ุงูุชุฑููุฒ ุนูู ุงุณุชุนุงุฏุฉ ุงููุฏุฑุงุช ุงููุธูููุฉ ุงููุงุฒูุฉ ูุฃุฏุงุก ูุชุทูุจุงุช ุงูุนูู.`,
        
        prognosis: `ุงูุชููุนุงุช ุงูุนูููุฉ ููุญุงูุฉ:

โข ูุณุจุฉ ุงูุชุญุณู ุงููุชููุนุฉ: 65-85% ุฎูุงู 12 ุฃุณุจูุน
โข ุงูุฌุฏูู ุงูุฒููู ููุชุนุงูู:
  - ุงูุฃุณุงุจูุน 1-4: ุชุญุณู ูู ุงููุฏุฑุงุช ุงูุฃุณุงุณูุฉ (20-30%)
  - ุงูุฃุณุงุจูุน 5-8: ุชุญุณู ูู ุงููุฏุฑุงุช ุงููุธูููุฉ (40-60%)
  - ุงูุฃุณุงุจูุน 9-12: ุงุณุชุนุงุฏุฉ ุงููุฏุฑุงุช ุงููุชูุฏูุฉ (65-85%)
โข ุงูุนูุงูู ุงูุฅูุฌุงุจูุฉ: ุงูุนูุฑ ุงูููุงุณุจุ ุงูุฏุงูุนูุฉ ููุชุญุณู
โข ุงูุนูุงูู ุงูุชู ุชุญุชุงุฌ ูุชุงุจุนุฉ: ุงูุฃุฏููุฉ ุงูุญุงููุฉุ ูุฌูุฏ ูุณูุฑ ุณุงุจูุฉ`,
        
        rehabPlan: `ุฎุทุฉ ุงูุชุฃููู ุงูุดุงููุฉ ููุฏุฉ 12 ุฃุณุจูุน:

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ใ ุงููุฑุญูุฉ ุงูุฃููู: ุงูุฃุณุงุจูุน 1-4 ใ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุฃูุฏุงู:
โ ุชุญุณูู ูุทุงู ุงูุญุฑูุฉ
โ ุชูููุฉ ุงูุนุถูุงุช ุงูุฃุณุงุณูุฉ
โ ุชุญุณูู ุงูุชูุงุฒู ุงูุฃููู

ุงูุจุฑูุงูุฌ ุงููููู:

โธ ุชูุงุฑูู ุงูุชููุณ ุงูุนููู:
  - 10 ุชูุฑุงุฑุงุช ร 3 ูุฌููุนุงุช
  - ุงูุงุณุชูุดุงู 4 ุซูุงูุ ุงูุฒููุฑ 6 ุซูุงู
  - ุฑุงุญุฉ 30 ุซุงููุฉ ุจูู ุงููุฌููุนุงุช

โธ ุชูุงุฑูู ุงูุฑูุจุฉ:
  - ุฏูุฑุงู ุงูุฑูุจุฉ: 5 ุชูุฑุงุฑุงุช ููู ุฌูุฉ ร 3 ูุฌููุนุงุช
  - ุซูู ูุจุณุท ุงูุฑูุจุฉ: 10 ุชูุฑุงุฑุงุช ร 3 ูุฌููุนุงุช
  - ุฑุงุญุฉ ุฏูููุฉ ุจูู ุงููุฌููุนุงุช

โธ ุชูุงุฑูู ุงูุฌุฐุน:
  - ุชูููุฉ ุนุถูุงุช ุงูุจุทู: 10 ุชูุฑุงุฑุงุช ร 2 ูุฌููุนุฉ
  - ุชูุงุฑูู ุงูุธูุฑ ุงูุฃุณุงุณูุฉ: 10 ุชูุฑุงุฑุงุช ร 2 ูุฌููุนุฉ
  - ูุฏุฉ ูู ุชูุฑูู: 5 ุซูุงู

โธ ุงููุดู ุงูุนูุงุฌู:
  - 5-10 ุฏูุงุฆู ร 2-3 ูุฑุงุช ููููุงู
  - ุงุณุชุฎุฏุงู ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ ุญุณุจ ุงูุญุงุฌุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ใ ุงููุฑุญูุฉ ุงููุชูุณุทุฉ: ุงูุฃุณุงุจูุน 5-8 ใ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุฃูุฏุงู:
โ ุชุญุณูู ุงูููุฉ ุงูุนุถููุฉ
โ ุชุทููุฑ ุงูุชูุงุฒู ุงูุฏููุงูููู
โ ุงูุจุฏุก ุจุงูุชูุงุฑูู ุงููุธูููุฉ

ุงูุจุฑูุงูุฌ ุงููุชูุฏู:

โธ ุชูุงุฑูู ุงูููุงููุฉ:
  - ุงุณุชุฎุฏุงู ุฃุญุฒูุฉ ุงูููุงููุฉ ุงูุฎูููุฉ
  - 15 ุชูุฑุงุฑ ร 3 ูุฌููุนุงุช ููู ูุฌููุนุฉ ุนุถููุฉ
  - ุฒูุงุฏุฉ ุงูููุงููุฉ ุชุฏุฑูุฌูุงู

โธ ุชูุงุฑูู ุงูุชูุงุฒู:
  - ุงููููู ุนูู ูุฏู ูุงุญุฏุฉ: 30 ุซุงููุฉ ร 3 ูุฑุงุช ููู ูุฏู
  - ุงููุดู ุนูู ุฎุท ูุณุชููู: 10 ุฎุทูุงุช ร 3 ูุฌููุนุงุช
  - ุชูุงุฑูู ููู ุงููุฒู

โธ ุงูุชูุงุฑูู ุงููุธูููุฉ:
  - ูุญุงูุงุฉ ุญุฑูุงุช ุงูุนูู ุงูุฃุณุงุณูุฉ
  - ุงูุชุฏุฑูุจ ุนูู ุงูุฌููุณ ูุงููููู: 15 ูุฑุฉ ร 3 ูุฌููุนุงุช
  - ุชูุงุฑูู ุงููุตูู ูุงูุฅูุณุงู

โธ ุงููุดู ุงููุชูุฏู:
  - 20-30 ุฏูููุฉ ููููุงู
  - ุชุถููู ุชุบููุฑุงุช ูู ุงูุณุฑุนุฉ ูุงูุงุชุฌุงู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ใ ุงููุฑุญูุฉ ุงููุชูุฏูุฉ: ุงูุฃุณุงุจูุน 9-12 ใ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ุงูุฃูุฏุงู:
โ ุงุณุชุนุงุฏุฉ ุงููุฏุฑุงุช ุงููุธูููุฉ ุงููุงููุฉ
โ ุงูุชุญุถูุฑ ููุนูุฏุฉ ููุนูู
โ ูุถุน ุจุฑูุงูุฌ ุงููุญุงูุธุฉ

ุงูุจุฑูุงูุฌ ุงููุชุฎุตุต:

โธ ุงูุชูุงุฑูู ุงููุธูููุฉ ุงููุชูุฏูุฉ:
  - ูุญุงูุงุฉ ููุงู ุงูุนูู ุงููุงููุฉ
  - ุชูุงุฑูู ุงูุชุญูู: 30-45 ุฏูููุฉ
  - ุชูุงุฑูู ุงูููุฉ ุงููุชูุฏูุฉ

โธ ุจุฑูุงูุฌ ุงูุนูุฏุฉ ููุนูู:
  - ูุญุงูุงุฉ ููู ุนูู ูุงูู
  - ุงูุชุฏุฑูุจ ุนูู ุงูููุงู ุงููุชุฎุตุตุฉ
  - ุฅุฏุงุฑุฉ ุงูุชุนุจ ูุงูุฅุฌูุงุฏ

โธ ุจุฑูุงูุฌ ุงููุญุงูุธุฉ:
  - ุชูุงุฑูู ููุฒููุฉ 3 ูุฑุงุช ุฃุณุจูุนูุงู
  - ุชูุงุฑูู ุงูุฅุทุงูุฉ ุงูููููุฉ
  - ูุตุงุฆุญ ุงูููุงูุฉ ูู ุงูุฅุตุงุจุงุช`,
        
        precautions: `ุงูุงุญุชูุงุทุงุช ุงูุทุจูุฉ ุงููููุฉ:

โ๏ธ ููุงูุน ุงูุงุณุชุฎุฏุงู:
โข ุฃูู ุญุงุฏ ููุงุฌุฆ
โข ุฏูุฎุฉ ุดุฏูุฏุฉ ุฃู ููุฏุงู ุงูุชูุงุฒู
โข ุถูู ูู ุงูุชููุณ ุบูุฑ ุทุจูุนู
โข ุชูุฑู ุฃู ุงุญูุฑุงุฑ ูู ุงูููุงุตู

โ๏ธ ุงุญุชูุงุทุงุช ุฎุงุตุฉ ุจุงูุฃุฏููุฉ:
โข ูุฑุงูุจุฉ ุถุบุท ุงูุฏู ูุจู ูุจุนุฏ ุงูุชูุงุฑูู
โข ุชุฌูุจ ุงูุชูุงุฑูู ุงูุดุงูุฉ ุจุนุฏ ุชูุงูู ุงูุฃุฏููุฉ ูุจุงุดุฑุฉ
โข ุงูุชูุณูู ูุน ุงูุทุจูุจ ุงููุนุงูุฌ ูุชุนุฏูู ุงูุฌุฑุนุงุช ุฅุฐุง ูุฒู

โ๏ธ ุงุญุชูุงุทุงุช ุฎุงุตุฉ ุจุงููุณูุฑ:
โข ุชุฌูุจ ุงูุชุญููู ุงููุจุงุดุฑ ุนูู ููุทูุฉ ุงููุณุฑ
โข ุงุณุชุฎุฏุงู ุงูุฏุนุงูุงุช ุงููุงููุฉ ุฃุซูุงุก ุงูุชูุงุฑูู
โข ุงููุชุงุจุนุฉ ุจุงูุฃุดุนุฉ ุญุณุจ ุชูุฌููุงุช ุงูุทุจูุจ

๐ ุฅุฑุดุงุฏุงุช ุนุงูุฉ:
โข ุงูุฅุญูุงุก ูุจู ูู ุฌูุณุฉ (5-10 ุฏูุงุฆู)
โข ุงูุชุจุฑูุฏ ุจุนุฏ ุงูุฌูุณุฉ (5 ุฏูุงุฆู)
โข ุดุฑุจ ุงููุงุก ุจุงูุชุธุงู
โข ุงูุฑุงุญุฉ ุงููุงููุฉ ุจูู ุงูุฌูุณุงุช`,
        
        reviewAppointments: `ุฌุฏูู ุงููุชุงุจุนุฉ ูุงููุฑุงุฌุนุฉ:

๐ ุงูุฃุณุจูุน ุงูุซุงูู:
โข ุชูููู ุงูุงุณุชุฌุงุจุฉ ุงูุฃูููุฉ ููุจุฑูุงูุฌ
โข ุชุนุฏูู ุดุฏุฉ ุงูุชูุงุฑูู ุญุณุจ ุงูุญุงุฌุฉ
โข ูุฑุงุฌุนุฉ ุชูููุงุช ุฃุฏุงุก ุงูุชูุงุฑูู

๐ ุงูุฃุณุจูุน ุงูุฑุงุจุน:
โข ุชูููู ุดุงูู ููุชูุฏู ุงููุญุฑุฒ
โข ููุงุณ ูุทุงู ุงูุญุฑูุฉ ูุงูููุฉ ุงูุนุถููุฉ
โข ุชุญุฏูุซ ุงูุฃูุฏุงู ูููุฑุญูุฉ ุงูุชุงููุฉ

๐ ุงูุฃุณุจูุน ุงูุซุงูู:
โข ุชูููู ููุชุตู ุงูุจุฑูุงูุฌ
โข ุงุฎุชุจุงุฑุงุช ูุธูููุฉ ูุชูุฏูุฉ
โข ููุงูุดุฉ ุฎุทุฉ ุงูุนูุฏุฉ ููุนูู

๐ ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ:
โข ุงูุชูููู ุงูููุงุฆู ุงูุดุงูู
โข ูุถุน ุจุฑูุงูุฌ ุงููุญุงูุธุฉ ุทููู ุงููุฏู
โข ุชูุตูุงุช ูููุชุงุจุนุฉ ุงููุณุชูุจููุฉ

๐ ูุชู ุชุญุชุงุฌ ููุฑุงุฌุนุฉ ุทุงุฑุฆุฉ:
โข ุธููุฑ ุฃุนุฑุงุถ ุฌุฏูุฏุฉ
โข ุชุฏููุฑ ูู ุงูุญุงูุฉ
โข ุนุฏู ุชุญุณู ุจุนุฏ 4 ุฃุณุงุจูุน
โข ุฃู ูุถุงุนูุงุช ุบูุฑ ูุชููุนุฉ`
      };
      
      // ุฅุฐุง ูุงู ุงูุฎุทุฃ ูุชุนูู ุจุงููููุฐุฌุ ูุฑุฌุน ุงูููู ุงูุงูุชุฑุงุถูุฉ
      if (error.message && (error.message.includes('Model') || error.message.includes('NOT_FOUND'))) {
        console.warn('Using fallback response due to model error');
        return fallbackResponse;
      }
      
      // ูู ุญุงูุงุช ุฃุฎุฑูุ ูุนูุฏ ุฑูู ุงูุฎุทุฃ
      throw new Error(`Failed to generate rehabilitation plan: ${error.message}`);
    }
  }
);

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชูุณูู ุงูุฎุทุฉ ุงูุชุฃููููุฉ ููุทุจุงุนุฉ ุฃู ุงูุนุฑุถ
export async function formatRehabPlan(plan: GenerateRehabPlanOutput): Promise<string> {
  const currentDate = new Date().toLocaleDateString('ar-SA', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  return `
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   ุชูุฑูุฑ ุงูุชุฃููู ุงูุทุจู ุงูุดุงูู                    โ
โ                      ุจุฑูุงูุฌ "ูุตูู" ุงูุทุจู                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุชุงุฑูุฎ ุงูุชูุฑูุฑ: ${currentDate}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
1๏ธโฃ ุงูุชุดุฎูุต ุงูุฃููู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${plan.initialDiagnosis}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
2๏ธโฃ ุงูุชููุนุงุช ุงูุนูููุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${plan.prognosis}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
3๏ธโฃ ุฎุทุฉ ุงูุชุฃููู ุงูุชูุตูููุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${plan.rehabPlan}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
4๏ธโฃ ุงูุงุญุชูุงุทุงุช ุงูุทุจูุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${plan.precautions}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
5๏ธโฃ ุฌุฏูู ุงููุชุงุจุนุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${plan.reviewAppointments}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         ูุฐุง ุงูุชูุฑูุฑ ุตุงุฏุฑ ูู ุจุฑูุงูุฌ "ูุตูู" ููุชุฃููู ุงูุทุจู          โ
โ            ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ 2025                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  `.trim();
}

// ุฏุงูุฉ ูุญูุธ ุงูุชูุฑูุฑ ูู PDF (ูููู ุงุณุชุฎุฏุงููุง ูุน ููุชุจุฉ PDF)
export async function prepareReportForPDF(plan: GenerateRehabPlanOutput, patientInfo: GenerateRehabPlanInput): Promise<{
  title: string;
  metadata: {
    subject: string;
    author: string;
    creator: string;
    producer: string;
    creationDate: Date;
  };
  content: {
    patientInfo: {
      age: number;
      gender: string;
      job: string;
      symptoms: string;
    };
    report: GenerateRehabPlanOutput;
    formattedReport: string;
  };
}> {
  return {
    title: 'ุชูุฑูุฑ ุงูุชุฃููู ุงูุทุจู',
    metadata: {
      subject: 'ุฎุทุฉ ุชุฃููู ุทุจูุฉ ุดุงููุฉ',
      author: 'ุจุฑูุงูุฌ ูุตูู ููุชุฃููู ุงูุทุจู',
      creator: 'Wassel Medical Rehabilitation System',
      producer: 'Wassel System v1.0',
      creationDate: new Date(),
    },
    content: {
      patientInfo: {
        age: patientInfo.age,
        gender: patientInfo.gender,
        job: patientInfo.job,
        symptoms: patientInfo.symptoms,
      },
      report: plan,
      formattedReport: await formatRehabPlan(plan),
    }
  };
}